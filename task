#!/usr/bin/env perl

use Modern::Perl;
use FindBin;
use Pod::Usage;
use Date::Manip;

use constant COMMANDS    => [ qw/man help start sub stop reset list flush time/ ];
use constant CONFIG_KEYS => qw/TIMESTAMP_FORMAT LOG_DIRECTORY LOG_FILE DEFAULT_TASK/;
use constant CONFIG_LINE => qr/^\s*(.*?)\s*=\s*(.*?)\s*$/;

=head1 NAME

  task - Simple task timer

=head1 SYNOPSIS

  task start bug fix           # start a timer
  task start another bug fix   # stop the first and start a new one
  task stop                    # stop the second timer
  task start a third bug fix   # start a third
  task sub part 1              # start a subtimer without stopping the running timer
  task stop                    # stop the sub timer
  task stop                    # stop the third timer

=head1 COMMANDS

=head2 OVERVIEW

The general syntax is

  task [command] [args...]

where command is one of

  start  - start a timer
  sub    - start a subtimer
  stop   - stop the current timer
  reset  - reset a timer
  list   - list all timers
  flush  - archive timers and start over
  time   - list current timer

Specific help for commands are available via

  task help [command]

The full man page is available via

  task man

=cut

{
    no strict 'refs';
    my $command = shift @ARGV;
    $command ~~ COMMANDS ? $command->(@ARGV) : pod2usage( -verbose => 1 );
}

# fetch the configuration
sub config {
    state $config;
    return $config if $config;

    # defaults
    $config = {
        TIMESTAMP_FORMAT => "%Y-%m-%d %H:%M:%S",
        LOG_DIRECTORY    => "$FindBin::Bin/log/",
        LOG_FILE         => "tasks",
        DEFAULT_TASK     => "task",
    };

    # update via config files and environment
    update_config($config, read_config($_)) for ("/etc/task-timer", "$ENV{HOME}/.task-timer", "./.task-timer");
    update_config($config, %ENV);
    return $config;
}

# read config values from the passed file
# right now we just ignore invalid lines
sub read_config {
    my ($file) = @_;
    return unless -e $file;
    open my $fh, "<", $file or die "Failed to open configuration file $file: $!";   
    return map { $_ =~ CONFIG_LINE  } <$fh>;
}

# update the config hash
sub update_config {
    my ($config, %values) = @_;
    map { $config->{$_} = $values{$_} if defined $values{$_} } CONFIG_KEYS;
}

# log the string to the log file
sub note {
    my $file = config->{LOG_DIRECTORY} . config->{LOG_FILE};
    open my $log, ">>", $file or die "Failed to open $file: $!";
    say $log UnixDate("now", config->{TIMESTAMP_FORMAT}) . " " . join(" ", @_);    
}

=head2 man

Get the full man page.

  task man

=cut
sub man {
    pod2usage( -verbose => 2 );
}

=head2 help

Get help for one of the commands.

  task help [command]

=cut
sub help {
    my ($command) = @_;
    pod2usage( -verbose => 99, -sections => "COMMANDS/" . ($command ~~ COMMANDS ? $command : "OVERVIEW") );
}

=head2 start

Start the timer for a new or existing task.

  task start [task name]

=cut
sub start {
    my ($label) = join " ", (@_ || config->{DEFAULT_TASK});
    say "Starting $label";
    note "start", $label;
}

sub sub {

}

sub stop {

}

sub reset {

}

sub list {

}

sub flush {

}

sub time {

}

=head1 DESCRIPTION

This program times and logs tasks using a serries of log files stored in the log directory. 

=head1 AUTHOR

Erik J. Sturcke

=cut
